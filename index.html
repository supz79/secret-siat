<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Secret Santa Beta.6+ (con rimozione partecipanti)</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#121b2e;
      --ink:#e7ecff;
      --muted:#aab5e6;
      --accent:#7c5cff;
      --danger:#ff4d6d;
      --ok:#2dd4bf;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(124,92,255,.22), transparent 55%),
                  radial-gradient(900px 700px at 85% 35%, rgba(45,212,191,.18), transparent 55%),
                  var(--bg);
      color:var(--ink);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .wrap{
      width:min(920px, 100%);
      display:grid;
      gap:18px;
      grid-template-columns: 1.1fr .9fr;
    }
    @media (max-width: 860px){
      .wrap{ grid-template-columns: 1fr; }
    }
    .card{
      background: rgba(18,27,46,.92);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
      backdrop-filter: blur(10px);
    }
    h1{
      margin:0 0 6px;
      font-size: 22px;
      letter-spacing:.2px;
    }
    .sub{
      margin:0 0 14px;
      color:var(--muted);
      font-size: 14px;
      line-height:1.4;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    input[type="text"]{
      flex: 1 1 260px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--ink);
      border-radius: 12px;
      padding: 12px 12px;
      outline: none;
    }
    input[type="text"]::placeholder{ color: rgba(231,236,255,.55); }
    button{
      appearance:none;
      border: 0;
      border-radius: 12px;
      padding: 12px 14px;
      color: var(--ink);
      background: rgba(255,255,255,.10);
      cursor: pointer;
      transition: transform .06s ease, background .16s ease, opacity .16s ease;
    }
    button:hover{ background: rgba(255,255,255,.14); }
    button:active{ transform: translateY(1px); }
    .btn-accent{ background: rgba(124,92,255,.28); border:1px solid rgba(124,92,255,.42); }
    .btn-accent:hover{ background: rgba(124,92,255,.36); }
    .btn-danger{ background: rgba(255,77,109,.18); border:1px solid rgba(255,77,109,.35); }
    .btn-danger:hover{ background: rgba(255,77,109,.26); }
    .btn-ok{ background: rgba(45,212,191,.16); border:1px solid rgba(45,212,191,.32); }
    .btn-ok:hover{ background: rgba(45,212,191,.22); }

    .chipbox{
      margin-top: 14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      min-height: 44px;
      padding: 10px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.12);
      background: rgba(0,0,0,.10);
    }

    /* === PARTECIPANTE + X (rimozione) === */
    .participant-btn{
      position: relative;
      padding: 10px 34px 10px 12px; /* spazio per la X */
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
      font-weight: 600;
      letter-spacing: .15px;
    }
    .participant-btn:hover{ background: rgba(255,255,255,.14); }
    .participant-btn .remove-x{
      position:absolute;
      top:50%;
      right:10px;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      display:grid;
      place-items:center;
      border-radius: 999px;
      font-weight: 900;
      line-height: 1;
      opacity: .78;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
      cursor: pointer;
      user-select: none;
    }
    .participant-btn .remove-x:hover{
      opacity: 1;
      background: rgba(255,77,109,.20);
      border-color: rgba(255,77,109,.36);
    }

    .meta{
      margin-top: 12px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      color: var(--muted);
      font-size: 13px;
    }
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }
    .divider{
      height:1px;
      background: rgba(255,255,255,.08);
      margin: 14px 0;
    }
    .result{
      font-size: 14px;
      color: var(--muted);
      line-height:1.5;
      white-space: pre-wrap;
    }
    .warn{ color: #ffd6dd; }
    .ok{ color: #c9fff6; }
    .tiny{ font-size: 12px; opacity:.9; }
    .footer{
      margin-top: 10px;
      color: rgba(231,236,255,.55);
      font-size: 12px;
    }
    a{ color: rgba(124,92,255,.95); text-decoration:none; }
    a:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <h1>Secret Santa üéÅ</h1>
      <p class="sub">
        Versione single-file con una modifica ‚Äúbasica ma vitale‚Äù: puoi <b>eliminare</b> un partecipante inserito male usando la <b>X</b> sul suo pulsante.
        (Nessun backend, tutto in locale.)
      </p>

      <div class="row">
        <input id="nameInput" type="text" placeholder="Aggiungi partecipante (es. Martina)" autocomplete="off" />
        <button id="addBtn" class="btn-accent" type="button">Aggiungi</button>
        <button id="drawBtn" class="btn-ok" type="button">Sorteggia</button>
        <button id="clearBtn" class="btn-danger" type="button">Svuota</button>
      </div>

      <div class="chipbox" id="participantsBox" aria-label="Partecipanti"></div>

      <div class="meta">
        <span class="pill" id="countPill">0 partecipanti</span>
        <span class="pill tiny">Suggerimento: premi Invio per aggiungere</span>
      </div>

      <div class="divider"></div>

      <div id="message" class="result"></div>

      <div class="footer">
        File pensato per essere caricato su GitHub Pages. Se vuoi riagganciarlo al tuo progetto esistente, puoi anche copiare solo la parte ‚Äúparticipant-btn + remove-x‚Äù.
      </div>
    </section>

    <aside class="card">
      <h1>Risultati</h1>
      <p class="sub">
        Qui compare l‚Äôesito del sorteggio. Per ora √® ‚Äúsemplice‚Äù: genera un‚Äôassegnazione valida (nessuno pesca s√© stesso).
      </p>
      <div id="results" class="result">(nessun sorteggio ancora)</div>

      <div class="divider"></div>

      <p class="sub tiny">
        Nota: questa pagina salva i partecipanti in <code>localStorage</code>.
        Se vuoi disattivarlo, elimina le funzioni <code>save()</code> / <code>load()</code>.
      </p>
    </aside>
  </div>

  <script>
    // ===== Stato =====
    let participants = [];

    const els = {
      input: document.getElementById('nameInput'),
      add: document.getElementById('addBtn'),
      draw: document.getElementById('drawBtn'),
      clear: document.getElementById('clearBtn'),
      box: document.getElementById('participantsBox'),
      msg: document.getElementById('message'),
      results: document.getElementById('results'),
      count: document.getElementById('countPill'),
    };

    // ===== Persistenza =====
    const STORAGE_KEY = 'secret-santa.participants.v1';

    function save(){
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(participants)); } catch {}
    }
    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        const parsed = JSON.parse(raw);
        if(Array.isArray(parsed)){
          participants = parsed.map(x => String(x).trim()).filter(Boolean);
        }
      } catch {}
    }

    // ===== UI helpers =====
    function setMessage(text, cls){
      els.msg.className = 'result' + (cls ? (' ' + cls) : '');
      els.msg.textContent = text || '';
    }
    function setResults(text, cls){
      els.results.className = 'result' + (cls ? (' ' + cls) : '');
      els.results.textContent = text || '';
    }
    function updateCount(){
      const n = participants.length;
      els.count.textContent = n + (n === 1 ? ' partecipante' : ' partecipanti');
    }

    // ===== Partecipante con X (QUI √à LA MODIFICA) =====
    function makeParticipantButton(name){
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'participant-btn';
      btn.dataset.name = name;

      const label = document.createElement('span');
      label.className = 'label';
      label.textContent = name;

      const x = document.createElement('span');
      x.className = 'remove-x';
      x.textContent = '√ó';
      x.title = 'Rimuovi';

      // Clic sulla X: rimuove senza attivare eventuali click del bottone
      x.addEventListener('click', (e) => {
        e.stopPropagation();
        removeParticipant(name);
      });

      btn.appendChild(label);
      btn.appendChild(x);

      return btn;
    }

    function renderParticipants(){
      els.box.innerHTML = '';
      for(const p of participants){
        els.box.appendChild(makeParticipantButton(p));
      }
      updateCount();
    }

    function normalizeName(s){
      return String(s || '').trim().replace(/\s+/g,' ');
    }

    function addParticipant(){
      const name = normalizeName(els.input.value);
      if(!name){
        setMessage('Inserisci un nome prima di aggiungere.', 'warn');
        return;
      }
      // evita doppioni (case-insensitive)
      const exists = participants.some(p => p.toLowerCase() === name.toLowerCase());
      if(exists){
        setMessage('Questo partecipante √® gi√† presente.', 'warn');
        return;
      }
      participants.push(name);
      els.input.value = '';
      setMessage('Aggiunto: ' + name, 'ok');
      setResults('(nessun sorteggio ancora)');
      renderParticipants();
      save();
    }

    function removeParticipant(name){
      const before = participants.length;
      participants = participants.filter(p => p !== name);
      if(participants.length === before){
        // fallback: rimuovi case-insensitive
        participants = participants.filter(p => p.toLowerCase() !== name.toLowerCase());
      }
      setMessage('Rimosso: ' + name, 'ok');
      setResults('(nessun sorteggio ancora)');
      renderParticipants();
      save();
    }

    function clearAll(){
      participants = [];
      save();
      renderParticipants();
      setMessage('Lista svuotata.', 'ok');
      setResults('(nessun sorteggio ancora)');
    }

    // ===== Sorteggio (derangement semplice) =====
    function shuffle(arr){
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function makeDerangement(names, maxTries = 2000){
      const n = names.length;
      if(n < 3) return null;

      const src = names.slice();
      for(let t = 0; t < maxTries; t++){
        const dst = shuffle(names.slice());
        let ok = true;
        for(let i = 0; i < n; i++){
          if(dst[i] === src[i]) { ok = false; break; }
        }
        if(ok) return {givers: src, receivers: dst};
      }
      return null;
    }

    function draw(){
      setMessage('');
      if(participants.length < 3){
        setMessage('Servono almeno 3 partecipanti per un sorteggio sensato.', 'warn');
        return;
      }
      const res = makeDerangement(participants);
      if(!res){
        setMessage('Non sono riuscito a trovare un sorteggio valido. Riprova.', 'warn');
        return;
      }
      const lines = res.givers.map((g,i) => '‚Ä¢ ' + g + ' ‚Üí ' + res.receivers[i]).join('\n');
      setResults(lines, 'ok');
      setMessage('Sorteggio completato ‚úÖ', 'ok');
    }

    // ===== Eventi =====
    els.add.addEventListener('click', addParticipant);
    els.draw.addEventListener('click', draw);
    els.clear.addEventListener('click', clearAll);

    els.input.addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){
        e.preventDefault();
        addParticipant();
      }
    });

    // Init
    load();
    renderParticipants();
  </script>
</body>
</html>
