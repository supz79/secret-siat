<!DOCTYPE html><html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>beta.4_fix_audio</title>  <style>
    body {
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      background: linear-gradient(180deg, #b3001e, #5c0a0f);
      color: #fff;
      padding: 1rem;
      text-align: center;
      min-height: 100vh;
      box-sizing: border-box;
      overflow-x: hidden;
    }

    h1 {
      margin-bottom: 0.6rem;
      font-size: 1.9rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
      color: #ffe8e8;
    }

    .card {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 14px;
      padding: 14px;
      margin: 14px auto;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
      max-width: 360px;
      border: 2px solid rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(4px);
    }

    button {
      background: linear-gradient(90deg, #0f8a20, #11b628);
      color: #ffffff;
      border: none;
      padding: 0.8rem 1rem;
      font-size: 1.05rem;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      margin: 10px auto 0 auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      transition: transform 0.15s ease;
      display: block;
    }

    button[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      filter: grayscale(40%);
    }

    input {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      padding: 0.8rem 1rem;
      border-radius: 10px;
      border: none;
      margin: 10px auto 0 auto;
      font-size: 1.05rem;
      background: rgba(255, 255, 255, 0.95);
      color: #3b0d0d;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: block;
    }

    .item {
      background: rgba(255, 255, 255, 0.25);
      padding: 10px;
      border-radius: 8px;
      margin-top: 8px;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      margin-left: auto;
      margin-right: auto;
      text-align: center;
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.3);
      display: block;
    }

    #output {
      margin-top: 10px;
      min-height: 40px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.18);
      box-sizing: border-box;
      font-size: 1.35rem; /* pi√π grande per i nomi estratti */
      font-weight: 800;
      letter-spacing: 0.4px;
    }

    .arrow-red{
      color:#b3001e;
      font-weight:900;
    }

    /* üéµ Pulsante audio sotto ‚ÄúMostra Prossimo‚Äù */
    /* OFF: rosso + bianco (candy cane classico) */
    .btn-music{
      background: repeating-linear-gradient(
        45deg,
        #b3001e 0px,
        #b3001e 12px,
        #ffffff 12px,
        #ffffff 22px
      );
      color: #ffffff;
      font-weight: 700;
      text-shadow: 0 0 2px #000, 0 0 4px #000;
    }

    /* ON: stesse righe rosse, le bianche diventano verdi */
    .btn-music.is-on{
      background: repeating-linear-gradient(
        45deg,
        #b3001e 0px,
        #b3001e 12px,
        #0f8a20 12px,
        #0f8a20 22px
      );
      color: #ffffff;
      text-shadow: 0 0 2px #000, 0 0 4px #000;
    }

    @media (max-width: 480px) {
      body { padding: 0.6rem; }
      h1 { font-size: 1.3rem; }
      .card { padding: 10px; }
    }

    /* ‚ùÑÔ∏è Fiocchi di neve animati */
    .snowflake {
      position: fixed;
      top: -10px;
      color: white;
      font-size: 1.2rem;
      user-select: none;
      pointer-events: none;
      animation: fall linear infinite;
      z-index: 9999;
    }

    @keyframes fall {
      0% { transform: translateY(-10vh); opacity: 1; }
      100% { transform: translateY(110vh); opacity: 0.3; }
    }
  </style>  <!-- PWA dynamic manifest -->  <script>
    const manifest = {
      name: "Secret Siat",
      short_name: "Secret Siat",
      start_url: ".",
      display: "standalone",
      background_color: "#a40f18",
      theme_color: "#a40f18",
      icons: [
        {
          src: "https://upload.wikimedia.org/wikipedia/commons/thumb/2/2d/Candy_cane_icon.png/256px-Candy_cane_icon.png",
          sizes: "256x256",
          type: "image/png",
        },
      ],
    };
    const blob = new Blob([JSON.stringify(manifest)], { type: "application/json" });
    const manifestURL = URL.createObjectURL(blob);
    const link = document.createElement("link");
    link.rel = "manifest";
    link.href = manifestURL;
    document.head.appendChild(link);

    // Dynamic service worker
    const swCode = `self.addEventListener('install', e => {
      self.skipWaiting();
      e.waitUntil(caches.open('santa-cache').then(c => c.addAll(['./'])));
    });
    self.addEventListener('fetch', e => {
      e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
    });`;

    const swBlob = new Blob([swCode], { type: "application/javascript" });
    const swURL = URL.createObjectURL(swBlob);

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register(swURL);
      });
    }
  </script></head>
<body>
  <h1>Secret Santa üéÑ Siat</h1>  <div class="card">
    <h2 style="margin:0 0 6px 0">Partecipanti</h2>
    <div id="listaPartecipanti"></div>
    <input id="nuovoPartecipante" placeholder="Nuovo partecipante" />
    <button id="btnAggiungiPartecipante">üéÑ Aggiungi</button>
  </div>  <div class="card">
    <h2 style="margin:0 0 6px 0">Vincoli</h2>
    <div id="listaVincoli"></div>
    <input id="vincolo1" placeholder="Persona A (es: Anna)" />
    <input id="vincolo2" placeholder="NON pu√≤ pescare B (es: Marco)" />
    <button id="btnAggiungiVincolo">üß¶ Aggiungi Vincolo</button>
  </div>  <div class="card">
    <button id="btnGenera">üéÅ Genera Estrazione Definitiva</button>
    <div id="output"></div>
    <button id="btnPdf" disabled>üìÑ Resoconto finale (PDF)</button>
    <button id="btnMostra" disabled>‚≠ê Mostra Prossimo (o premi Invio)</button>
    <button id="btnMusic" class="btn-music">üîá Audio OFF</button>
  </div>  <!-- Musica di sottofondo in loop -->  <audio id="bgmusic" preload="auto" loop playsinline>
    <source src="audio.mp3" type="audio/mpeg" />
  </audio>  <script>
    // Stato principale
    let partecipanti = [];
    let vincoli = [];
    let accoppiamenti = [];
    let indiceCorrente = 0;

    // Riferimenti agli elementi
    const listaPartecipantiEl = document.getElementById("listaPartecipanti");
    const listaVincoliEl = document.getElementById("listaVincoli");
    const btnMostra = document.getElementById("btnMostra");
    const btnPdf = document.getElementById("btnPdf");
    const btnMusic = document.getElementById("btnMusic");
    const outputEl = document.getElementById("output");
    const bgmusic = document.getElementById("bgmusic");

    function aggiornaListe() {
      const icone = [
        "üî•","üåô","‚≠ê","üçÄ","üéß","üê±","üöÄ","üåà",
        "‚ö°","üß©","üé®","üé∏","ü¶ä","üê¢","üåª","üç©"
      ];

      // Mappa nome ‚Üí icona, coerente con la lista partecipanti
      const iconaPerNome = {};
      partecipanti.forEach((p, i) => {
        iconaPerNome[p] = icone[i % icone.length];
      });

      // Lista partecipanti: icona assegnata + nome
      listaPartecipantiEl.innerHTML = partecipanti
        .map((p) => {
          const ic = iconaPerNome[p] || "üë§";
          return `<div class="item">${ic} ${p}</div>`;
        })
        .join("");

      // Lista vincoli: nome1 con la sua icona ‚ùå nome2 con la sua icona
      listaVincoliEl.innerHTML = vincoli
        .map(([a, b]) => {
          const icA = iconaPerNome[a] || "üë§";
          const icB = iconaPerNome[b] || "üë§";
          return `<div class="item">${icA} ${a} ‚ùå ${icB} ${b}</div>`;
        })
        .join("");
    }

    // Aggiungi partecipante
    document
      .getElementById("btnAggiungiPartecipante")
      .addEventListener("click", () => {
        const input = document.getElementById("nuovoPartecipante");
        const val = input.value.trim();
        if (val && !partecipanti.includes(val)) {
          partecipanti.push(val);
        }
        input.value = "";
        aggiornaListe();
      });

    // Aggiungi vincolo
    document
      .getElementById("btnAggiungiVincolo")
      .addEventListener("click", () => {
        const a = document.getElementById("vincolo1").value.trim();
        const b = document.getElementById("vincolo2").value.trim();
        if (a && b) {
          vincoli.push([a, b]);
        }
        document.getElementById("vincolo1").value = "";
        document.getElementById("vincolo2").value = "";
        aggiornaListe();
      });

    // Genera estrazione definitiva
    document.getElementById("btnGenera").addEventListener("click", genera);

    function genera() {
      // reset stato precedente
      accoppiamenti = [];
      indiceCorrente = 0;
      outputEl.textContent = "";
      btnMostra.disabled = true;
      btnPdf.disabled = true;

      if (partecipanti.length < 2) {
        outputEl.textContent = "Aggiungi almeno 2 partecipanti.";
        return;
      }

      // Considera solo vincoli con nomi effettivamente presenti
      const vincoliFiltrati = vincoli.filter(
        (v) => partecipanti.includes(v[0]) && partecipanti.includes(v[1])
      );

      const copia = [...partecipanti];
      let trovato = false;

      for (let tent = 0; tent < 5000; tent++) {
        const pescati = [...copia];
        // Fisher-Yates shuffle
        for (let i = pescati.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [pescati[i], pescati[j]] = [pescati[j], pescati[i]];
        }

        let ok = true;
        for (let i = 0; i < copia.length; i++) {
          const giver = copia[i];
          const receiver = pescati[i];
          if (giver === receiver) {
            ok = false;
            break;
          }
          if (vincoliFiltrati.some((v) => v[0] === giver && v[1] === receiver)) {
            ok = false;
            break;
          }
        }

        if (ok) {
          accoppiamenti = copia.map((p, i) => `${p} <span class="arrow-red">‚ûú</span> ${pescati[i]}`);
          trovato = true;
          break;
        }
      }

      if (trovato) {
        outputEl.textContent = 'Estrazione pronta! Premi "Mostra Prossimo".';
        btnMostra.disabled = false;
        btnPdf.disabled = true; // il PDF sar√† disponibile solo dopo che tutti sono stati mostrati
      } else {
        outputEl.textContent = "Impossibile generare combinazioni valide con i vincoli attuali.";
        btnMostra.disabled = true;
        btnPdf.disabled = true;
      }
    }

    // Mostra il prossimo abbinamento
    function mostraProssimo() {
      if (!accoppiamenti.length) {
        outputEl.textContent = 'Nessuna estrazione disponibile. Premi "Genera Estrazione Definitiva" prima.';
        return;
      }

      if (indiceCorrente < accoppiamenti.length) {
        outputEl.innerHTML = accoppiamenti[indiceCorrente];
        indiceCorrente++;
      }

      if (indiceCorrente >= accoppiamenti.length) {
        btnMostra.disabled = true;
        btnPdf.disabled = false;
      }
    }

    btnMostra.addEventListener("click", mostraProssimo);

    // Resoconto PDF: apre una pagina stampabile con tutti gli abbinamenti
    function scaricaResoconto() {
      if (!accoppiamenti.length) {
        outputEl.textContent = 'Nessuna estrazione disponibile per il resoconto.';
        return;
      }

      if (indiceCorrente < accoppiamenti.length) {
        outputEl.textContent = 'Completa prima la visualizzazione di tutti gli abbinamenti con "Mostra Prossimo".';
        return;
      }

      const now = new Date().toLocaleString('it-IT');
      let html = `<!DOCTYPE html><html lang="it"><head><meta charset="UTF-8"><title>Resoconto Secret Santa</title>`;
      html += `<style>body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;margin:20px;background:#fafafa;color:#222;}h1{font-size:1.6rem;margin-bottom:0.2rem;}ul{margin-top:1rem;padding-left:1.2rem;}li{margin:0.2rem 0;font-size:1.05rem;}small{color:#666;}</style>`;html += `</head><body>`;
  html += `<h1>Resoconto Secret Santa üéÑ</h1>`;
  html += `<p><small>Generato il ${now}</small></p>`;
  html += `<ul>`;
  accoppiamenti.forEach((riga) => {
    html += `<li>${riga}</li>`;
  });
  html += `</ul>`;
  html += `<p><small>Consiglio: usa il comando Stampa del browser e scegli "Salva come PDF".</small></p>`;
  html += `<script>window.onload = function(){ window.print(); };<\/script>`;
  html += `</body></html>`;

  document.open();
  document.write(html);
  document.close();
}

  if (indiceCorrente < accoppiamenti.length) {
    outputEl.textContent = 'Completa prima la visualizzazione di tutti gli abbinamenti con "Mostra Prossimo".';
    return;
  }

  const now = new Date().toLocaleString('it-IT');
  let html = `<!DOCTYPE html><html lang="it"><head><meta charset="UTF-8"><title>Resoconto Secret Santa</title>`;
  html += `<style>body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;margin:20px;background:#fafafa;color:#222;}h1{font-size:1.6rem;margin-bottom:0.2rem;}ul{margin-top:1rem;padding-left:1.2rem;}li{margin:0.2rem 0;font-size:1.05rem;}small{color:#666;}</style>`;
  html += `</head><body>`;
  html += `<h1>Resoconto Secret Santa üéÑ</h1>`;
  html += `<p><small>Generato il ${now}</small></p>`;
  html += `<ul>`;
  accoppiamenti.forEach((riga) => {
    html += `<li>${riga}</li>`;
  });
  html += `</ul>`;
  html += `<p><small>Consiglio: usa il comando Stampa del browser e scegli "Salva come PDF".</small></p>`;
  html += `<script>window.onload = function(){ window.print(); };<\/script>`;
  html += `</body></html>`;

  document.open();
  document.write(html);
  document.close();
}

btnPdf.addEventListener("click", scaricaResoconto);

// Invio = Mostra Prossimo (se attivo)
document.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !btnMostra.disabled) {
    e.preventDefault();
    mostraProssimo();
  }
});

// üéµ Audio ON/OFF (Android: parte solo dopo un tap)
let musicUnlocked = false;
let musicOn = false;

const updateMusicBtn = () => {
  btnMusic.textContent = musicOn ? "üéÑ Musica ON" : "üéÑ Musica OFF";
  btnMusic.classList.toggle("is-on", musicOn);
};

updateMusicBtn();

// Tentativo autoplay (desktop). Se fallisce, resta OFF e l'utente attiva col bottone.
window.addEventListener("load", () => {
  if (!bgmusic) return;
  bgmusic.volume = 0.8;
  bgmusic.play().then(() => {
    musicUnlocked = true;
    musicOn = true;
    updateMusicBtn();
  }).catch(() => {
    musicUnlocked = false;
    musicOn = false;
    updateMusicBtn();
  });
});

btnMusic.addEventListener("click", async () => {
  try {
    // OFF = pausa (mantiene il punto corrente)
    if (musicOn) {
      bgmusic.pause();
      musicOn = false;
      updateMusicBtn();
      return;
    }

    // ON = play (riprende dallo stesso punto; NON tocchiamo currentTime)
    await bgmusic.play();
    musicUnlocked = true;
    musicOn = true;
    updateMusicBtn();
  } catch (e) {
    console.warn("Audio toggle failed:", e);
    btnMusic.textContent = "Tocca ancora üîä";
  }
});

  </script>  <script>
    /* ‚ùÑÔ∏è Generatore di fiocchi di neve */
    function creaFiocco() {
      const fiocco = document.createElement("div");
      fiocco.className = "snowflake";
      fiocco.textContent = "‚ùÑ";

      fiocco.style.left = Math.random() * 100 + "vw";
      fiocco.style.fontSize = Math.random() * 12 + 10 + "px";
      fiocco.style.animationDuration = Math.random() * 5 + 5 + "s";
      fiocco.style.opacity = Math.random();

      document.body.appendChild(fiocco);
      setTimeout(() => fiocco.remove(), 12000);
    }

    setInterval(creaFiocco, 250);
  </script></body>
</html>