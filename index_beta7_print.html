<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Siat Secret Santa</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#121b2e;
      --ink:#e7ecff;
      --muted:#aab5e6;
      --accent:#7c5cff;
      --ok:#2dd4bf;
      --danger:#ff4d6d;
      --line:rgba(255,255,255,.10);
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(124,92,255,.22), transparent 55%),
                  radial-gradient(900px 700px at 85% 35%, rgba(45,212,191,.18), transparent 55%),
                  var(--bg);
      color:var(--ink);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .wrap{
      width:min(980px, 100%);
      display:grid;
      gap:18px;
      grid-template-columns: 1fr 1fr;
    }
    @media (max-width: 920px){ .wrap{ grid-template-columns: 1fr; } }
    .card{
      background: rgba(18,27,46,.92);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
      backdrop-filter: blur(10px);
    }
    h1,h2{ margin:0 0 10px; }
    h1{ font-size: 22px; }
    h2{ font-size: 16px; color: var(--muted); font-weight: 650; letter-spacing:.2px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex: 1 1 auto; }

    input[type="text"], select{
      width:100%;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--ink);
      border-radius: 12px;
      padding: 11px 12px;
      outline: none;
    }
    input::placeholder{ color: rgba(231,236,255,.55); }
    select option{ color:#111; }

    button{
      appearance:none;
      border: 0;
      border-radius: 12px;
      padding: 11px 14px;
      color: var(--ink);
      background: rgba(255,255,255,.10);
      cursor: pointer;
      transition: transform .06s ease, background .16s ease, opacity .16s ease;
      white-space: nowrap;
    }
    button:hover{ background: rgba(255,255,255,.14); }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.45; cursor:not-allowed; }

    .btn-accent{ background: rgba(124,92,255,.28); border:1px solid rgba(124,92,255,.42); }
    .btn-accent:hover{ background: rgba(124,92,255,.36); }

    .btn-ok{ background: rgba(45,212,191,.16); border:1px solid rgba(45,212,191,.32); }
    .btn-ok:hover{ background: rgba(45,212,191,.22); }

    .btn-danger{ background: rgba(255,77,109,.18); border:1px solid rgba(255,77,109,.35); }
    .btn-danger:hover{ background: rgba(255,77,109,.26); }

    .chipbox{
      margin-top: 12px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      min-height: 44px;
      padding: 10px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.12);
      background: rgba(0,0,0,.10);
    }
    .meta{
      margin-top: 10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      color:var(--muted);
      font-size: 13px;
    }
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }

    /* Chip partecipante + X (rimozione) */
    .participant-btn{
      position: relative;
      padding: 9px 34px 9px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
      font-weight: 650;
      letter-spacing: .15px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .participant-btn .remove-x{
      position:absolute;
      right:10px;
      top:50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      font-weight: 900;
      line-height: 1;
      opacity: .88;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
      cursor: pointer;
      user-select: none;
    }
    .participant-btn .remove-x:hover{
      opacity: 1;
      background: rgba(255,77,109,.20);
      border-color: rgba(255,77,109,.36);
    }

    /* Vincoli list */
    .constraint{
      position: relative;
      padding: 9px 34px 9px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--ink);
      font-size: 14px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .constraint .remove-x{
      position:absolute;
      right:10px;
      top:50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      font-weight: 900;
      line-height: 1;
      opacity: .88;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
      cursor: pointer;
      user-select:none;
    }
    .constraint .remove-x:hover{
      opacity: 1;
      background: rgba(255,77,109,.20);
      border-color: rgba(255,77,109,.36);
    }

    .divider{ height:1px; background: rgba(255,255,255,.08); margin: 14px 0; }

    .box{
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(0,0,0,.10);
    }
    .result{
      white-space: pre-wrap;
      color: var(--muted);
      line-height: 1.5;
      font-size: 14px;
      min-height: 48px;
    }
    .ok{ color:#c9fff6; }
    .warn{ color:#ffd6dd; }
    .tiny{ font-size: 12px; opacity:.9; }
    .rightActions{ justify-content:flex-end; }

    /* ========= STAMPA ========= */
    @media print {
      @page { size: A4; margin: 14mm; }
      *{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      body{
        background: white !important;
        color: #111 !important;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        font-size: 11pt;
        line-height: 1.35;
      }
      body *{ visibility: hidden !important; }
      #printArea, #printArea *{ visibility: visible !important; }
      #printArea{
        position: fixed;
        inset: 0;
        padding: 0;
      }
      #printArea .print-header{
        display:flex;
        align-items:center;
        gap:10mm;
        margin-bottom: 6mm;
        padding-bottom: 4mm;
        border-bottom: 1px solid #ddd;
      }
      #printArea .brand-mark{
        width: 16mm;
        height: 16mm;
        border-radius: 4mm;
        background: #0b5fa5;
      }
      #printArea h1{ font-size: 16pt; margin:0; color:#111 !important; }
      #printArea .meta{
        color: #444 !important;
        font-size: 10pt;
        margin-top: 1mm;
      }
      #printArea table{
        width: 100%;
        border-collapse: collapse;
        margin-top: 6mm;
      }
      #printArea th, #printArea td{
        text-align: left;
        padding: 3.2mm 2.5mm;
        border-bottom: 1px solid #eee;
        vertical-align: top;
        color:#111 !important;
      }
      #printArea th{
        font-size: 10pt;
        color: #333 !important;
        border-bottom: 1px solid #ddd;
      }
      #printArea tr{ break-inside: avoid; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <section class="card">
      <h1>Siat Secret Santa üéÅ</h1>
      <div class="tiny" style="color:rgba(231,236,255,.65)">Beta.7 (layout stampa migliorato)</div>

      <div class="divider"></div>

      <h2>Partecipanti</h2>
      <div class="row">
        <input id="nameInput" type="text" placeholder="Aggiungi partecipante (Invio)" autocomplete="off" />
        <button id="addBtn" class="btn-accent" type="button">Aggiungi</button>
        <button id="clearBtn" class="btn-danger" type="button">Svuota</button>
      </div>
      <div class="chipbox" id="participantsBox"></div>
      <div class="meta">
        <span class="pill" id="countPill">0 partecipanti</span>
        <span class="pill tiny">Suggerimento: usa la √ó per correggere</span>
      </div>

      <div class="divider"></div>

      <h2>Vincoli</h2>
      <div class="row">
        <select id="fromSelect" aria-label="Chi non pu√≤ regalare">
          <option value="">Da‚Ä¶</option>
        </select>
        <select id="toSelect" aria-label="A chi non pu√≤ regalare">
          <option value="">A‚Ä¶</option>
        </select>
        <button id="addConstraintBtn" class="btn-accent" type="button">Aggiungi vincolo</button>
      </div>

      <div class="chipbox" id="constraintsBox" aria-label="Vincoli"></div>

      <div class="divider"></div>

      <div class="row rightActions">
        <button id="generateBtn" class="btn-ok" type="button">Genera estrazione definitiva</button>
        <button id="pdfBtn" type="button" disabled>Resoconto finale (PDF) ‚≠ê</button>
        <button id="nextBtn" type="button" disabled>Mostra prossimo (o Invio)</button>
        <button id="audioBtn" type="button">Audio OFF</button>
      </div>

      <div class="divider"></div>
      <div id="message" class="result"></div>
    </section>

    <aside class="card">
      <h2>Output</h2>
      <div class="box">
        <div class="tiny" style="color:rgba(231,236,255,.65); margin-bottom:8px">
          La rivelazione ‚ÄúMostra prossimo‚Äù √® pensata per passare il telefono a turno.
        </div>
        <div id="reveal" class="result">(nessuna estrazione ancora)</div>
      </div>

      <div class="divider"></div>

      <h2>Diagnostica</h2>
      <div id="debug" class="result tiny">‚Äî</div>
    </aside>
  </div>

  <!-- ========= AREA STAMPA ========= -->
  <div id="printArea" style="display:none">
    <div class="print-header">
      <div class="brand-mark"></div>
      <div>
        <h1>Siat Secret Santa - Resoconto finale</h1>
        <div class="meta" id="printMeta"></div>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:45%">Partecipante</th>
          <th style="width:55%">Regala a</th>
        </tr>
      </thead>
      <tbody id="printTableBody"></tbody>
    </table>
  </div>

  <audio id="ding" preload="auto">
    <source src="audio.mp3" type="audio/mpeg">
  </audio>

  <script>
    // ========= PWA single-file (manifest + SW dinamici) =========
    const baseURL = new URL("./", location.href).href;

    const manifest = {
      name: "Siat Secret Santa",
      short_name: "Siat Secret Santa",
      start_url: ".",
      display: "standalone",
      background_color: "#0b5fa5",
      theme_color: "#0b5fa5",
      icons: [
        { src: new URL("icon-192.png", baseURL).href, sizes: "192x192", type: "image/png" },
        { src: new URL("icon-512.png", baseURL).href, sizes: "512x512", type: "image/png" }
      ],
    };

    const blob = new Blob([JSON.stringify(manifest)], { type: "application/json" });
    const manifestURL = URL.createObjectURL(blob);
    const link = document.createElement("link");
    link.rel = "manifest";
    link.href = manifestURL;
    document.head.appendChild(link);

    const swCode = `self.addEventListener('install', e => {
      self.skipWaiting();
      e.waitUntil(caches.open('santa-cache-v1').then(c => c.addAll(['./'])));
    });
    self.addEventListener('fetch', e => {
      e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
    });`;

    const swBlob = new Blob([swCode], { type: "application/javascript" });
    const swURL = URL.createObjectURL(swBlob);

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => { navigator.serviceWorker.register(swURL); });
    }

    // ========= Stato app =========
    let participants = [];
    let constraints = [];
    let accoppiamenti = [];
    let revealIndex = 0;
    let audioEnabled = false;

    const els = {
      nameInput: document.getElementById("nameInput"),
      addBtn: document.getElementById("addBtn"),
      clearBtn: document.getElementById("clearBtn"),
      participantsBox: document.getElementById("participantsBox"),
      constraintsBox: document.getElementById("constraintsBox"),
      fromSelect: document.getElementById("fromSelect"),
      toSelect: document.getElementById("toSelect"),
      addConstraintBtn: document.getElementById("addConstraintBtn"),
      generateBtn: document.getElementById("generateBtn"),
      pdfBtn: document.getElementById("pdfBtn"),
      nextBtn: document.getElementById("nextBtn"),
      audioBtn: document.getElementById("audioBtn"),
      message: document.getElementById("message"),
      reveal: document.getElementById("reveal"),
      countPill: document.getElementById("countPill"),
      debug: document.getElementById("debug"),
      ding: document.getElementById("ding"),
    };

    function normalizeName(s){ return String(s || "").trim().replace(/\s+/g, " "); }

    function setMessage(text, cls){
      els.message.className = "result" + (cls ? (" " + cls) : "");
      els.message.textContent = text || "";
    }
    function setReveal(text, cls){
      els.reveal.className = "result" + (cls ? (" " + cls) : "");
      els.reveal.textContent = text || "";
    }
    function updateCount(){
      const n = participants.length;
      els.countPill.textContent = n + (n === 1 ? " partecipante" : " partecipanti");
    }
    function resetEstrazione(){
      accoppiamenti = [];
      revealIndex = 0;
      els.pdfBtn.disabled = true;
      els.nextBtn.disabled = true;
      setReveal("(nessuna estrazione ancora)");
    }

    // ========= Partecipanti =========
    function makeParticipantChip(name){
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "participant-btn";
      btn.dataset.name = name;

      const label = document.createElement("span");
      label.textContent = name;

      const x = document.createElement("span");
      x.className = "remove-x";
      x.textContent = "√ó";
      x.title = "Rimuovi";
      x.addEventListener("click", (e) => { e.stopPropagation(); removeParticipant(name); });

      btn.appendChild(label);
      btn.appendChild(x);
      return btn;
    }

    function renderParticipants(){
      els.participantsBox.innerHTML = "";
      participants.forEach(p => els.participantsBox.appendChild(makeParticipantChip(p)));
      updateCount();
      refreshConstraintSelects();
      renderConstraints();
      renderDebug();
    }

    function addParticipant(){
      const name = normalizeName(els.nameInput.value);
      if(!name){ setMessage("Inserisci un nome prima di aggiungere.", "warn"); return; }
      const exists = participants.some(p => p.toLowerCase() === name.toLowerCase());
      if(exists){ setMessage("Questo partecipante √® gi√† presente.", "warn"); return; }
      participants.push(name);
      els.nameInput.value = "";
      setMessage("Aggiunto: " + name, "ok");
      resetEstrazione();
      renderParticipants();
    }

    function removeParticipant(name){
      participants = participants.filter(p => p !== name);
      constraints = constraints.filter(v => v.from !== name && v.to !== name);
      setMessage("Rimosso: " + name, "ok");
      resetEstrazione();
      renderParticipants();
    }

    function clearAll(){
      participants = [];
      constraints = [];
      setMessage("Lista svuotata.", "ok");
      resetEstrazione();
      renderParticipants();
    }

    // ========= Vincoli =========
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function refreshConstraintSelects(){
      const currentFrom = els.fromSelect.value;
      const currentTo = els.toSelect.value;

      const baseFrom = ['<option value="">Da‚Ä¶</option>']
        .concat(participants.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`))
        .join("");
      const baseTo = ['<option value="">A‚Ä¶</option>']
        .concat(participants.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`))
        .join("");

      els.fromSelect.innerHTML = baseFrom;
      els.toSelect.innerHTML = baseTo;

      if(participants.includes(currentFrom)) els.fromSelect.value = currentFrom;
      if(participants.includes(currentTo)) els.toSelect.value = currentTo;
    }

    function makeConstraintChip(c){
      const div = document.createElement("div");
      div.className = "constraint";

      const label = document.createElement("span");
      label.textContent = `${c.from} non pu√≤ regalare a ${c.to}`;

      const x = document.createElement("span");
      x.className = "remove-x";
      x.textContent = "√ó";
      x.title = "Rimuovi vincolo";
      x.addEventListener("click", () => {
        constraints = constraints.filter(v => !(v.from === c.from && v.to === c.to));
        setMessage("Vincolo rimosso.", "ok");
        resetEstrazione();
        renderConstraints();
        renderDebug();
      });

      div.appendChild(label);
      div.appendChild(x);
      return div;
    }

    function renderConstraints(){
      els.constraintsBox.innerHTML = "";
      constraints.forEach(c => els.constraintsBox.appendChild(makeConstraintChip(c)));
    }

    function addConstraint(){
      const from = els.fromSelect.value;
      const to = els.toSelect.value;
      if(!from || !to){ setMessage("Seleziona entrambi i nomi per aggiungere un vincolo.", "warn"); return; }
      if(from === to){ setMessage("Vincolo non valido: la persona sarebbe vietata a s√© stessa.", "warn"); return; }
      const exists = constraints.some(v => v.from === from && v.to === to);
      if(exists){ setMessage("Questo vincolo esiste gi√†.", "warn"); return; }
      constraints.push({from, to});
      setMessage("Vincolo aggiunto.", "ok");
      resetEstrazione();
      renderConstraints();
      renderDebug();
    }

    // ========= Estrazione =========
    function shuffle(arr){
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function isForbidden(giver, receiver){
      return constraints.some(v => v.from === giver && v.to === receiver);
    }

    function generateAssignments(maxTries = 8000){
      const n = participants.length;
      if(n < 3) return null;
      const givers = participants.slice();

      for(let t = 0; t < maxTries; t++){
        const receivers = shuffle(participants.slice());
        let ok = true;

        for(let i = 0; i < n; i++){
          if(receivers[i] === givers[i]) { ok = false; break; }
          if(isForbidden(givers[i], receivers[i])) { ok = false; break; }
        }
        if(!ok) continue;

        if(new Set(receivers).size !== receivers.length) continue;

        return givers.map((g,i) => ({giver: g, receiver: receivers[i]}));
      }
      return null;
    }

    function generateDefinitive(){
      const res = generateAssignments();
      if(!res){
        setMessage("Impossibile generare combinazioni valide con questi vincoli. Prova a rimuoverne qualcuno.", "warn");
        return;
      }
      accoppiamenti = res;
      revealIndex = 0;
      els.pdfBtn.disabled = false;
      els.nextBtn.disabled = false;
      setMessage("Estrazione definitiva generata ‚úÖ", "ok");
      setReveal("Pronto! Premi ‚ÄúMostra prossimo‚Äù e passa il telefono.");
      renderDebug();
    }

    function showNext(){
      if(!accoppiamenti || accoppiamenti.length === 0){
        setMessage("Prima genera l'estrazione definitiva.", "warn");
        return;
      }
      if(revealIndex >= accoppiamenti.length){
        setReveal("Fine! Tutti hanno ricevuto il loro destinatario ‚úÖ", "ok");
        els.nextBtn.disabled = true;
        return;
      }

      const pair = accoppiamenti[revealIndex];
      revealIndex++;

      if(audioEnabled){
        try { els.ding.currentTime = 0; els.ding.play(); } catch {}
      }

      setReveal(`${pair.giver} ‚Üí ${pair.receiver}`, "ok");
      setMessage(`Rivelazione ${revealIndex}/${accoppiamenti.length}`, "");
      renderDebug();
    }

    // ========= Stampa =========
    function preparaStampa(){
      if(!accoppiamenti || accoppiamenti.length === 0){
        setMessage("Nessuna estrazione disponibile da stampare.", "warn");
        return;
      }

      const now = new Date();
      document.getElementById("printMeta").textContent =
        `Generato il ${now.toLocaleDateString()} alle ${now.toLocaleTimeString()}`;

      const tbody = document.getElementById("printTableBody");
      tbody.innerHTML = "";
      accoppiamenti.forEach(pair => {
        const tr = document.createElement("tr");
        const td1 = document.createElement("td");
        td1.textContent = pair.giver;
        const td2 = document.createElement("td");
        td2.textContent = pair.receiver;
        tr.appendChild(td1);
        tr.appendChild(td2);
        tbody.appendChild(tr);
      });

      const printArea = document.getElementById("printArea");
      printArea.style.display = "block";
      window.print();
      printArea.style.display = "none";
    }

    function toggleAudio(){
      audioEnabled = !audioEnabled;
      els.audioBtn.textContent = audioEnabled ? "Audio ON" : "Audio OFF";
      setMessage(audioEnabled ? "Audio attivato." : "Audio disattivato.", "ok");
    }

    function renderDebug(){
      const n = participants.length;
      const c = constraints.length;
      const a = accoppiamenti.length;
      els.debug.textContent =
        `Partecipanti: ${n}
Vincoli: ${c}
Estrazione definitiva: ${a ? "S√å" : "no"}
` +
        (a ? `Rivelazioni: ${revealIndex}/${a}` : "");
    }

    // ========= Eventi =========
    els.addBtn.addEventListener("click", addParticipant);
    els.clearBtn.addEventListener("click", clearAll);
    els.addConstraintBtn.addEventListener("click", addConstraint);
    els.generateBtn.addEventListener("click", generateDefinitive);
    els.nextBtn.addEventListener("click", showNext);
    els.pdfBtn.addEventListener("click", preparaStampa);
    els.audioBtn.addEventListener("click", toggleAudio);

    els.nameInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){ e.preventDefault(); addParticipant(); }
    });

    window.addEventListener("keydown", (e) => {
      if(e.key === "Enter" && !els.nameInput.matches(":focus")){
        if(!els.nextBtn.disabled) showNext();
      }
    });

    // init
    renderParticipants();
    renderConstraints();
    renderDebug();
  </script>
</body>
</html>
