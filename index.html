<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Siat Secret Santa</title>

  <style>
    body {
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      background: linear-gradient(180deg, #b3001e, #5c0a0f);
      color: #fff;
      padding: 1rem;
      text-align: center;
      min-height: 100vh;
      box-sizing: border-box;
      overflow-x: hidden;
    }

    h1 {
      margin-bottom: 0.6rem;
      font-size: 1.9rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
      color: #ffe8e8;
    }

    .card {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 14px;
      padding: 14px;
      margin: 14px auto;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
      max-width: 360px;
      border: 2px solid rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(4px);
    }

    button {
      background: linear-gradient(90deg, #0f8a20, #11b628);
      color: #ffffff;
      border: none;
      padding: 0.8rem 1rem;
      font-size: 1.05rem;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      margin: 10px auto 0 auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      transition: transform 0.15s ease;
      display: block;
    }
      background: rgba(255, 255, 255, 0.25);
      padding: 10px 40px 10px 10px; /* spazio a destra per la X */
      border-radius: 8px;
      margin-top: 8px;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      margin-left: auto;
      margin-right: auto;
      text-align: center;
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.3);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .remove-x{
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-weight: 800;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      user-select: none;
      background: rgba(0,0,0,0.20);
      border: 1px solid rgba(255,255,255,0.25);
    }
    .remove-x:hover{
      background: rgba(255, 77, 109, 0.22);
      border-color: rgba(255, 77, 109, 0.45);
    }

    #output {
      margin-top: 10px;
      min-height: 40px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.18);
      box-sizing: border-box;
      font-size: 1.35rem; /* pi√π grande per i nomi estratti */
      font-weight: 800;
      letter-spacing: 0.4px;
    }

    .arrow-red{
      color:#b3001e;
      font-weight:900;
    }

    /* üéµ Pulsante audio sotto ‚ÄúMostra Prossimo‚Äù */
    /* OFF: rosso + bianco (candy cane classico) */
    .btn-music{
      background: repeating-linear-gradient(
        45deg,
        #b3001e 0px,
        #b3001e 12px,
        #ffffff 12px,
        #ffffff 22px
      );
      color: #ffffff;
      font-weight: 700;
      text-shadow: 0 0 2px #000, 0 0 4px #000;
    }

    /* ON: stesse righe rosse, le bianche diventano verdi */
    .btn-music.is-on{
      background: repeating-linear-gradient(
        45deg,
        #b3001e 0px,
        #b3001e 12px,
        #0f8a20 12px,
        #0f8a20 22px
      );
      color: #ffffff;
      text-shadow: 0 0 2px #000, 0 0 4px #000;
    }

    @media (max-width: 480px) {
      body { padding: 0.6rem; }
      h1 { font-size: 1.3rem; }
      .card { padding: 10px; }
    }

    /* ‚ùÑÔ∏è Fiocchi di neve animati */
    .snowflake {
      position: fixed;
      top: -10px;
      color: white;
      font-size: 1.2rem;
      user-select: none;
      pointer-events: none;
      animation: fall linear infinite;
      z-index: 9999;
    }

    @keyframes fall {
      0% { transform: translateY(-10vh); opacity: 1; }
      100% { transform: translateY(110vh); opacity: 0.3; }
    }

    /* =========================
       STAMPA RESOCONTO (NUOVO)
       Non tocca il layout web:
       agisce solo su stampa.
       ========================= */
    @media print {
      @page { size: A4; margin: 14mm; }

      *{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }

      body{
        background: #fff !important;
        color: #111 !important;
        text-align: left !important;
        padding: 0 !important;
      }

      /* Nascondi tutto... */
      body *{ visibility: hidden !important; }

      /* ...tranne l'area stampa */
      #printArea, #printArea *{ visibility: visible !important; }

      #printArea{
        display:block !important;
        position: fixed;
        inset: 0;
        padding: 0;
      }

      #printArea .print-wrap{
        padding: 0;
      }

      #printArea .print-header{
        display:flex;
        align-items:center;
        gap: 10mm;
        padding-bottom: 4mm;
        margin-bottom: 6mm;
        border-bottom: 1px solid #ddd;
      }

      #printArea .brand-mark{
        width: 16mm;
        height: 16mm;
      }

      #printArea h1{
        margin:0;
        font-size: 16pt;
        color:#111 !important;
        text-shadow: none !important;
      }

      #printArea .meta{
        margin-top: 1mm;
        font-size: 10pt;
        color:#444 !important;
      }

      #printArea table{
        width: 100%;
        border-collapse: collapse;
        margin-top: 6mm;
      }

      #printArea th, #printArea td{
        text-align: left;
        padding: 3.2mm 2.5mm;
        border-bottom: 1px solid #eee;
        vertical-align: top;
        color:#111 !important;
        font-size: 11pt;
      }

      #printArea th{
        font-size: 10pt;
        color:#333 !important;
        border-bottom: 1px solid #ddd;
      }

      #printArea tr{ break-inside: avoid; }
    }
  </style>

  <!-- PWA dynamic manifest -->
  <script>
    const baseURL = new URL("./", location.href).href;

const manifest = {
  name: "Secret Siat",
  short_name: "Secret Siat",
  start_url: ".",
  display: "standalone",
  background_color: "#0b5fa5",
  theme_color: "#0b5fa5",
  icons: [
    { src: new URL("icon-192.png", baseURL).href, sizes: "192x192", type: "image/png" },
    { src: new URL("icon-512.png", baseURL).href, sizes: "512x512", type: "image/png" }
  ]
};
    const blob = new Blob([JSON.stringify(manifest)], { type: "application/json" });
    const manifestURL = URL.createObjectURL(blob);
    const link = document.createElement("link");
    link.rel = "manifest";
    link.href = manifestURL;
    document.head.appendChild(link);

    // Dynamic service worker
    const swCode = `self.addEventListener('install', e => {
      self.skipWaiting();
      e.waitUntil(caches.open('santa-cache').then(c => c.addAll(['./'])));
    });
    self.addEventListener('fetch', e => {
      e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
    });`;

    const swBlob = new Blob([swCode], { type: "application/javascript" });
    const swURL = URL.createObjectURL(swBlob);

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register(swURL);
      });
    }
  </script>
</head>
<body>
  <h1>üéÑSiat Secret SantaüéÑ</h1>

  <div class="card">
    <h2 style="margin:0 0 6px 0">Partecipanti</h2>
    <div id="listaPartecipanti"></div>
    <input id="nuovoPartecipante" placeholder="Nuovo partecipante" />
    <button id="btnAggiungiPartecipante">üéÑ Aggiungi</button>
  </div>

  <div class="card">
  <h2 style="margin:0 0 6px 0">Vincoli</h2>
  <div id="listaVincoli"></div>
  <input id="vincolo1" placeholder="Persona A (es: Anna)" />
  <input id="vincolo2" placeholder="NON pu√≤ pescare B (es: Marco)" />
  <button id="btnAggiungiVincolo">üß¶ Aggiungi Vincolo</button>

  <!-- üîÅ Toggle scambi reciproci (parte dei vincoli) -->
  <button id="btnReciproci">üîÅ Scambi reciproci: OFF</button>
</div>

  <div class="card">
    <button id="btnGenera">üéÅ Genera Estrazione Definitiva</button>

     <div id="output"></div>
<button id="btnMostra" disabled>‚≠ê Mostra Prossimo (o premi Invio)</button>
<button id="btnPdf" disabled>üìÑ Resoconto finale (PDF)</button>
    
  </div>
  <div class="card">
  <h2 style="margin:0 0 6px 0">Musica</h2>
  <button id="btnMusic" class="btn-music">üîá Audio OFF</button>
</div>

  <!-- ========= AREA STAMPA (NUOVO) ========= -->
  <div id="printArea" style="display:none">
    <div class="print-wrap">
      <div class="print-header">
        <img
  src="icon-512.png"
  alt="Logo SIAT"
  class="brand-mark"
        />
          <h1>Siat Secret Santa - Resoconto finale</h1>
          <div class="meta" id="printMeta"></div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:45%">Partecipante</th>
            <th style="width:55%">Regala a</th>
          </tr>
        </thead>
        <tbody id="printTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Musica di sottofondo in loop -->
  <audio id="bgmusic" preload="auto" loop playsinline>
    <source src="audio.mp3" type="audio/mpeg" />
  </audio>

  <script>
    // Debug-friendly: se qualcosa va storto, mostriamo un messaggio invece di ‚Äúnon funziona nulla‚Äù.
    window.addEventListener('error', (e) => {
      const out = document.getElementById('output');
      if (out) out.textContent = 'Errore nello script: ' + (e?.message || 'controlla la Console');
      console.error(e);
    });

    // Stato principale
    let partecipanti = [];
    let vincoli = [];
    let accoppiamenti = []; // array di oggetti: { giver, receiver }
    let indiceCorrente = 0;

    // üîÅ Toggle reciproci (default OFF)
    let consentiReciproci = false;

    // Riferimenti agli elementi
    const listaPartecipantiEl = document.getElementById('listaPartecipanti');
    const listaVincoliEl = document.getElementById('listaVincoli');
    const btnMostra = document.getElementById('btnMostra');
    const btnPdf = document.getElementById('btnPdf');
    const btnMusic = document.getElementById('btnMusic');
    const btnReciproci = document.getElementById('btnReciproci');
    const outputEl = document.getElementById('output');
    const bgmusic = document.getElementById('bgmusic');

    // Stato/label del bottone reciproci
    const updateReciprociBtn = () => {
      if (!btnReciproci) return;
      btnReciproci.textContent = consentiReciproci
        ? 'üîÅ Scambi reciproci: ON'
        : 'üîÅ Scambi reciproci: OFF';
    };
    updateReciprociBtn();

    // Click: toggle + reset estrazione per coerenza
    btnReciproci?.addEventListener('click', () => {
      consentiReciproci = !consentiReciproci;
      updateReciprociBtn();

      accoppiamenti = [];
      indiceCorrente = 0;
      btnMostra.disabled = true;
      btnPdf.disabled = true;
      outputEl.textContent = '';
    });

    // Rimozione partecipante con X (event delegation)
    listaPartecipantiEl.addEventListener('click', (e) => {
      const x = e.target.closest('.remove-x');
      if (!x) return;
      const item = e.target.closest('.item');
      if (!item) return;

      const idx = Number(item.dataset.idx);
      if (!Number.isInteger(idx)) return;

      const nome = partecipanti[idx];
      if (!nome) return;

      // Rimuovi da lista partecipanti
      partecipanti.splice(idx, 1);

      // Rimuovi vincoli che coinvolgono quel nome
      vincoli = vincoli.filter((v) => v[0] !== nome && v[1] !== nome);

      // Reset estrazione in corso (coerenza UI)
      accoppiamenti = [];
      indiceCorrente = 0;
      btnMostra.disabled = true;
      btnPdf.disabled = true;
      outputEl.textContent = '';

      aggiornaListe();
    });


    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function aggiornaListe() {
      const icone = [
        'üî•','üåô','‚≠ê','üçÄ','üéß','üê±','üöÄ','üåà',
        '‚ö°','üß©','üé®','üé∏','ü¶ä','üê¢','üåª','üç©'
      ];

      // Mappa nome ‚Üí icona, coerente con la lista partecipanti
      const iconaPerNome = {};
      partecipanti.forEach((p, i) => {
        iconaPerNome[p] = icone[i % icone.length];
      });

      listaPartecipantiEl.innerHTML = partecipanti
        .map((p, i) => {
          const ic = iconaPerNome[p] || 'üë§';
          return `<div class="item" data-idx="${i}"><span class="label">${ic} ${escapeHtml(p)}</span><span class="remove-x" title="Rimuovi">√ó</span></div>`;
        })
        .join('');

      listaVincoliEl.innerHTML = vincoli
        .map(([a, b]) => {
          const icA = iconaPerNome[a] || 'üë§';
          const icB = iconaPerNome[b] || 'üë§';
          return `<div class="item">${icA} ${escapeHtml(a)} ‚ùå ${icB} ${escapeHtml(b)}</div>`;
        })
        .join('');
    }

    // Aggiungi partecipante
    document.getElementById('btnAggiungiPartecipante').addEventListener('click', () => {
      const input = document.getElementById('nuovoPartecipante');
      const val = input.value.trim();
      if (val && !partecipanti.includes(val)) {
        partecipanti.push(val);
      }
      input.value = '';
      aggiornaListe();
    });

    // Aggiungi vincolo
    document.getElementById('btnAggiungiVincolo').addEventListener('click', () => {
      const a = document.getElementById('vincolo1').value.trim();
      const b = document.getElementById('vincolo2').value.trim();
      if (a && b) {
        vincoli.push([a, b]);
      }
      document.getElementById('vincolo1').value = '';
      document.getElementById('vincolo2').value = '';
      aggiornaListe();
    });

    // Genera estrazione definitiva
    document.getElementById('btnGenera').addEventListener('click', genera);

    function genera() {
      accoppiamenti = [];
      indiceCorrente = 0;
      outputEl.textContent = '';
      btnMostra.disabled = true;
      btnPdf.disabled = true;

      if (partecipanti.length < 2) {
        outputEl.textContent = 'Aggiungi almeno 2 partecipanti.';
        return;
      }

      // Se sono 2 partecipanti, serve consentire gli scambi reciproci
      if (partecipanti.length === 2 && !consentiReciproci) {
        outputEl.textContent = 'Con 2 partecipanti √® necessario attivare gli scambi reciproci.';
        return;
      }

      const vincoliFiltrati = vincoli.filter(
        (v) => partecipanti.includes(v[0]) && partecipanti.includes(v[1])
      );

      const copia = [...partecipanti];
      let trovato = false;

      for (let tent = 0; tent < 5000; tent++) {
        const pescati = [...copia];
        for (let i = pescati.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [pescati[i], pescati[j]] = [pescati[j], pescati[i]];
        }

        let ok = true;
        for (let i = 0; i < copia.length; i++) {
          const giver = copia[i];
          const receiver = pescati[i];

          // ‚ùå niente auto-regalo
          if (giver === receiver) { ok = false; break; }

          // ‚ùå vincoli manuali
          if (vincoliFiltrati.some((v) => v[0] === giver && v[1] === receiver)) {
            ok = false; break;
          }

          // ‚ùå NO scambio reciproco (solo se toggle OFF)
          if (!consentiReciproci) {
            const idxReceiver = copia.indexOf(receiver);
            if (idxReceiver !== -1 && pescati[idxReceiver] === giver) {
              ok = false; break;
            }
          }
        }

        if (ok) {
          accoppiamenti = copia.map((giver, i) => ({ giver, receiver: pescati[i] }));
          trovato = true;
          break;
        }
      }

      if (trovato) {
        outputEl.textContent = 'Estrazione pronta! Premi "Mostra Prossimo".';
        btnMostra.disabled = false;
        btnPdf.disabled = true;
      } else {
        outputEl.textContent = 'Impossibile generare combinazioni valide con i vincoli attuali.';
        btnMostra.disabled = true;
        btnPdf.disabled = true;
      }
    }

    function renderAccoppiamento(r) {
      const giver = escapeHtml(r.giver);
      const receiver = escapeHtml(r.receiver);
      return `${giver} <span class="arrow-red">‚ûú</span> ${receiver}`;
    }

    // Mostra il prossimo abbinamento
    function mostraProssimo() {
      if (!accoppiamenti.length) {
        outputEl.textContent = 'Nessuna estrazione disponibile. Premi "Genera Estrazione Definitiva" prima.';
        return;
      }

      if (indiceCorrente < accoppiamenti.length) {
        outputEl.innerHTML = renderAccoppiamento(accoppiamenti[indiceCorrente]);
        indiceCorrente++;
      }

      if (indiceCorrente >= accoppiamenti.length) {
        btnMostra.disabled = true;
        btnPdf.disabled = false;
      }
    }

    btnMostra.addEventListener('click', mostraProssimo);

    // Resoconto PDF: NUOVA STAMPA (senza distruggere l'app)
    function scaricaResoconto() {
      if (!accoppiamenti.length) {
        outputEl.textContent = 'Nessuna estrazione disponibile per il resoconto.';
        return;
      }
      if (indiceCorrente < accoppiamenti.length) {
        outputEl.textContent = 'Completa prima la visualizzazione di tutti gli abbinamenti con "Mostra Prossimo".';
        return;
      }

      // Meta (data/ora)
      const now = new Date().toLocaleString('it-IT');
      const metaEl = document.getElementById('printMeta');
      if (metaEl) metaEl.textContent = `Generato il ${now}`;

      // Tabella
      const tbody = document.getElementById('printTableBody');
      if (!tbody) {
        outputEl.textContent = 'Layout di stampa non trovato (#printTableBody).';
        return;
      }
      tbody.innerHTML = '';
      accoppiamenti.forEach((r) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(r.giver)}</td><td>${escapeHtml(r.receiver)}</td>`;
        tbody.appendChild(tr);
      });

      // Mostra area stampa e stampa
      const area = document.getElementById('printArea');
      if (area) area.style.display = 'block';

      // dopo la stampa, nascondi di nuovo
      const cleanup = () => {
        if (area) area.style.display = 'none';
        window.removeEventListener('afterprint', cleanup);
      };
      window.addEventListener('afterprint', cleanup);

      window.print();

      // fallback: alcuni browser non scatenano afterprint
      setTimeout(cleanup, 1500);
    }

    btnPdf.addEventListener('click', scaricaResoconto);

    // Invio = Mostra Prossimo (se attivo)
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !btnMostra.disabled) {
        e.preventDefault();
        mostraProssimo();
      }
    });

    // üéµ Audio ON/OFF (Android: parte solo dopo un tap)
    let musicOn = false;

    const updateMusicBtn = () => {
      if (!btnMusic) return;
      btnMusic.textContent = musicOn ? 'üéÑ Musica ON' : 'üéÑ Musica OFF';
      btnMusic.classList.toggle('is-on', musicOn);
    };
    updateMusicBtn();

    // Desktop: prova autoplay, ma non √® obbligatorio.
    window.addEventListener('load', () => {
      if (!bgmusic) return;
      bgmusic.volume = 0.8;
      bgmusic.play().then(() => {
        musicOn = true;
        updateMusicBtn();
      }).catch(() => {
        musicOn = false;
        updateMusicBtn();
      });
    });

    btnMusic?.addEventListener('click', async () => {
      if (!bgmusic) return;
      try {
        if (musicOn) {
          bgmusic.pause();
          musicOn = false;
        } else {
          await bgmusic.play();
          musicOn = true;
        }
        updateMusicBtn();
      } catch (e) {
        console.warn('Audio toggle failed:', e);
        btnMusic.textContent = 'Tocca ancora üîä';
      }
    });
  </script>

  <script>
    /* ‚ùÑÔ∏è Generatore di fiocchi di neve */
    function creaFiocco() {
      const fiocco = document.createElement("div");
      fiocco.className = "snowflake";
      fiocco.textContent = "‚ùÑ";

      fiocco.style.left = Math.random() * 100 + "vw";
      fiocco.style.fontSize = Math.random() * 12 + 10 + "px";
      fiocco.style.animationDuration = Math.random() * 5 + 5 + "s";
      fiocco.style.opacity = Math.random();

      document.body.appendChild(fiocco);
      setTimeout(() => fiocco.remove(), 12000);
    }

    setInterval(creaFiocco, 250);
  </script>
</body>
</html>
