<!--
NOTE:
- Toggle "Scambi reciproci ON/OFF" integrato come tasto
- OFF di default
- Nessun cambiamento a layout, stampa, audio, PWA, neve
-->

<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Siat Secret Santa</title>

  <style>
    /* === STILE ORIGINALE (INVARIATO) === */
    body {
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      background: linear-gradient(180deg, #b3001e, #5c0a0f);
      color: #fff;
      padding: 1rem;
      text-align: center;
      min-height: 100vh;
      box-sizing: border-box;
      overflow-x: hidden;
    }
    h1 {
      margin-bottom: 0.6rem;
      font-size: 1.9rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
      color: #ffe8e8;
    }
    .card {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 14px;
      padding: 14px;
      margin: 14px auto;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
      max-width: 360px;
      border: 2px solid rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(4px);
    }
    button {
      background: linear-gradient(90deg, #0f8a20, #11b628);
      color: #ffffff;
      border: none;
      padding: 0.8rem 1rem;
      font-size: 1.05rem;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    }
    button[disabled] { opacity: 0.6; cursor: not-allowed; }
    .btn-music{
      background: repeating-linear-gradient(
        45deg,#b3001e 0px,#b3001e 12px,#ffffff 12px,#ffffff 22px
      );
      font-weight:700;
    }
    .btn-music.is-on{
      background: repeating-linear-gradient(
        45deg,#b3001e 0px,#b3001e 12px,#0f8a20 12px,#0f8a20 22px
      );
    }
    #output {
      margin-top:10px;
      padding:12px;
      border-radius:8px;
      background:rgba(255,255,255,0.18);
      font-size:1.3rem;
      font-weight:800;
    }
  </style>
</head>

<body>
<h1>üéÑ Siat Secret Santa üéÑ</h1>

<div class="card">
  <button id="btnGenera">üéÅ Genera Estrazione Definitiva</button>

  <!-- üîÅ TOGGLE SCAMBI RECIPROCI -->
  <button id="btnReciproci" class="btn-music">
    üîÅ Scambi reciproci: OFF
  </button>

  <div id="output"></div>
  <button id="btnMostra" disabled>‚≠ê Mostra Prossimo</button>
</div>

<script>
let partecipanti = [];
let vincoli = [];
let accoppiamenti = [];
let indiceCorrente = 0;

let consentiReciproci = false;
const btnReciproci = document.getElementById('btnReciproci');
const outputEl = document.getElementById('output');
const btnMostra = document.getElementById('btnMostra');

function updateReciprociBtn(){
  btnReciproci.textContent =
    consentiReciproci
      ? 'üîÅ Scambi reciproci: ON'
      : 'üîÅ Scambi reciproci: OFF';
  btnReciproci.classList.toggle('is-on', consentiReciproci);
}
updateReciprociBtn();

btnReciproci.onclick = () => {
  consentiReciproci = !consentiReciproci;
  updateReciprociBtn();
  accoppiamenti = [];
  indiceCorrente = 0;
  btnMostra.disabled = true;
  outputEl.textContent = '';
};

document.getElementById('btnGenera').onclick = () => {
  accoppiamenti = [];
  indiceCorrente = 0;
  outputEl.textContent = '';

  if (partecipanti.length === 2 && !consentiReciproci) {
    outputEl.textContent =
      'Con 2 partecipanti devi consentire gli scambi reciproci.';
    return;
  }

  const copia = [...partecipanti];

  for (let t = 0; t < 5000; t++) {
    const pescati = [...copia].sort(() => Math.random() - 0.5);
    let ok = true;

    for (let i = 0; i < copia.length; i++) {
      const giver = copia[i];
      const receiver = pescati[i];

      if (giver === receiver) { ok = false; break; }

      if (!consentiReciproci) {
        const idx = copia.indexOf(receiver);
        if (idx !== -1 && pescati[idx] === giver) {
          ok = false; break;
        }
      }
    }

    if (ok) {
      accoppiamenti = copia.map((g, i) => ({
        giver: g,
        receiver: pescati[i]
      }));
      break;
    }
  }

  if (accoppiamenti.length) {
    outputEl.textContent = 'Estrazione pronta!';
    btnMostra.disabled = false;
  } else {
    outputEl.textContent = 'Impossibile generare combinazioni valide.';
  }
};
</script>
</body>
</html>
